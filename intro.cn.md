# 第一章 引言

## 这是一本什么样的书

《Go语言日常》这本书，看书名的话，一半是Go语言，一半是日常。直截了当的解释，就是我用Go语言开发中发生的日常。显然，这是一本伴随实际开发而产生的书，里面记载的都是日常开发遇到的问题。这是一本进阶书。

那我为什不叫它《Go语言进阶》，或者《Go语言实战》呢？坦白地回想的话，这种名字的书已经不在少数，我再取类似的名字，就不够标新立异了，怎么卖得好？而且“日常”这两个字，确实能体现它的特色：

一方面，它确实是用于“日常开发”的书，它记录的是每个Go语言程序员在每日的开发工作中会遇到的问题，会去网上查资料，会反复思考（因为会反复遇到）的问题。为什么这么确定？因为我就是这么过来的啊。我记录的问题，基本就是自己遇到的问题。

另一方面，它的生成过程，也是我“日常”积累出来的。这本书的写作绝不是想了个标题就埋头苦干的出来的，必须经过足够的积累，经历过那些问题，才能写出来。因此日常这个词，也能体现它的出身之处。要不是最终成书后，各种话题都重新整理了脉络，我甚至可以叫它《Go语言日记》了。

## 我为什么要写这本书

但读者也许只看封面和介绍的话，并不知道一个可怕的事实：写这本书之前，我并没有写过Go语言代码！

我是一个Java/C++出身的老式程序员，虽然也用过D、Python，但Go、Rust、Swift这些新时代的语言，虽一直有所耳闻，也看过一些粗略的资料，但其实并没有开发过实际的商用代码。我不敢说自己写过Go语言代码，除非Go Tutorial上那些可以在线执行的示例代码也算。

但我可以问心无愧的说自己是个Senior程序员了。毕竟开发了十年的代码，填过了无数的坑，也了解很多语言，对于如何克服日常开发遇到的困难，如何解决问题，如何搜索自己解决不了的问题，如何总结经验教训，我都是个中老手。

但在Go语言的使用上，我还是新手。写这本书，实际上是我学习的一个过程。估计我会重新趟过无数人趟过的泥坑，收拾零落，蹒跚前行，最终修炼成为一个合格的Go语言程序员。这本书问世的时候，估计大家就能看到我的收获了。它是什么呢？

它就是我写这本书的真正原因：NeoReads开源工程。

我写这本书的初衷，就是为了开发这个app。Go语言，就是我为它的后台所选择的的开发语言。当初做技术选型的时候，我给自己定了三个原则：

1. 效率高
2. 成本低
3. 受众广

效率高，程序跑得快，写得也快，自然天下武功唯快不破了。

成本低，我的这个app才运营的起来啊。你们如果看过这个app的介绍，就知道是我一个人在运营。又不能打广告，初期公版内容又不能收费，估计只能靠读者们打赏一两个铜子儿度日。但app后台都是跑在云服务器上的，马云爸爸可是一个铜子都不会给我节约，只能靠自己。内存、硬盘、流量，都要节约。从语言节约起。

受众广，这个app既然是开源的，那目的只有一个，吸引更多的同好来一起开发。既然如此，自然要选择用的人多，最火爆的技术。这年头后台云端最火的技术是什么？大家一起说！Go！Go！Go！

前端暂且不论，那是今后另一本书的话题了。但后端里，满足这三条原则的语言，真是少之又少。敢不敢列个表看看？

| 语言 | 运行效率 | 开发效率 | 运行成本 | 受众 |
| --- | --- | --- | --- | --- |
| C/C++ | 高 | 低 | 低 | 广 |
| Python | 低 | 高 | 高 | 广 |
| Java | 中 | 中 | 高 | 广 |
| Go | 高 | 高 | 低 | 广 |
| NodeJS | 低 | 高 | 高 | 广 |
| Kotlin | 中 | 高 | 高 | 少 |
| Scala | 中 | 高 | 高 | 少 |
| D | 高 | 高 | 低 | 少 |
| Rust | 高 | 高 | 低 | 少 |
| Swift | 高 | 高 | 低 | 中 | 

我们的需求是 "高、高、低、广"，看到这个表格里谁最符合？大家一起说！Go！Go！Go！
实际上，只有Go语言一个，三条原则都符合。

当然，如果把每一项分成五个档次，分别打星，互相之间对比就更清晰了。但是可惜的是，在这里，Go语言都不用对比到五档打星的程度，是唯一的选择。

我当初本来打算选择D或者Java的。D是我个人最喜爱的语言，但是奈何受众实在太少了，用来做后台，估计吸引不到几个同好一起开发。并且我个人的价值观也发生了变化（技术渣男？），已经从D走了出来，打算未来自己设计一门语言，而且名字都想好了，就叫Venus（技术渣男无疑了）。而如果用Java，或者说Kotlin，那么是我最熟悉的领域，应该很好啊，并且如果用Kotlin，那和前端Android/Kotlin的技术盏完美对接，不是最好吗？可惜啊可惜，JVM对内存的消耗简直到了可耻的程度，让我这种看包租公马云爸爸脸色存活的云租客，直呼养不起！只好忍痛分手。

最后还有一根稻草，或者说最后一株玫瑰，就是Rob Pike的演讲，Google I/O 2012 - Go Concurrency Patterns，链接是<https://www.youtube.com/watch?v=f6kdp27TYZs>。Rob Pike讲了Go语言如何用并发来实现各种需求，列举了好几个场景。我看了以后大受启发，原来并发可以这么简单的做出来！这种感受是看Go Tour之类的入门资料无法感受到的。我想写这本书，很大的一个原因也是想自己组织语言，把他说的Go并发模式，再总结一下。

因此我决定用Go来开发NeoReads的后台。接着我就去读了几本入门书籍，然后，准备动手。这时候突然发下，只看了入门书籍之后，好像还有很多东西没弄明白呢。不论是并发，还是网络操作，我都还只是了解一下皮毛而已。继续开发，个中遇到的很多问题，还是得通过谷歌百度，StackOverflow，Go语言社区，在线文档，甚至阅读第三方库源码来解决。这样的情况遇到几次后，就心生感慨，要是有一本书，总结了日常开发遇到的各种问题，即可以供案头参考，又可以浏览学习，岂不美哉？

恰好，NeoReads是一个关于阅读的应用。那么，最能展现它的好处的途径是什么呢？我得出来的结论是：写一本关于它的书！这就是《Go语言日常》的由来。在这本书里，我会记录自己设计、开发这个应用过程中，遇到的种种问题，并归因到相应的话题中，总结成册。以后自己日常开发的过程中，再遇到类似问题，就有案头可查之书了。而如果有幸出版，则可以为广大的初中级Go语言程序员们提供服务，帮大家省去很多查找问题的功夫。

最后，写作本身就是一个学习途径，它能帮助我们更清晰地整理自己的思路。我对阅读和写作的理解是这样的：读书只是一个认识的过程，把读到的东西用自己的话语写出来，才能真正有机会摸透它，堪破它。为什么这么说，因为写作本身，也是一个不断重写、不断优化的过程，这和写代码一样。

而且我的开源代码，因为要写成书，必然对代码的简洁性，可读性，文档的丰富度有了新的要求。这对于我的最终目标：高质量的开源工程来说，是非常好的激励。

最后，我希望这次尝试，可以给大家一个新的视角。我发现市面上很少有介于入门和进阶之间的书籍。然而初中级程序员是对这种书籍需求最大的群体。我猜测是这样的原因：一方面，入门书籍潜在的消费者最多，写了好卖，自然写得人也多；另一方面，高阶的书籍受众较少，对作者的要求也高得多，因此较少有人写。那些编程高手，有时间估计也都去写代码了，谁有那功夫写书？我希望这本书的尝试，可以让大家看到，写书也是能促进写代码的，而且并不只入门书需求大。这样如果能吸引更多的人，补全技术书籍的这个空白，自然是极好的事情。

## 这本书是给谁看的

我写这本书，首先是给我自己看的。

写作圣经之一的《On Writing Well》中，作者Zinsser也说过，“You're writing for yourself”。不管是什么书，都是这个答案。

这本书是我的个人工程开发的配套书籍，因此记录的都是我——作为一个Go语言程序员——所遇到、关注、感兴趣、担心的问题，并记录我的观察、搜索、学习、解决和感慨。这是一个自己与自己对话的过程，一个技术与心灵成长和积累的过程。

是的，这本书其实是一个日记、笔记、博客、百科全书的杂交体。来源自然是日常的积累，而且打算以博客的形式做分话题的发表和反馈收集，最后再用心编织在一起成书。这整个过程，加上修改的流程，每一段话，我至少要细读五六遍。估计不会有哪位读者有功夫读这么多。所以我说是写给自己。

当然，独乐了不如众乐乐，这本书写好了之后，自然是希望能带给大家看。我希望大家能看到我的挣扎、我的迷茫、我的执着、我的喜悦，以及我的冷静观察与总结。我希望大家看了之后，不但能收获技术的愉悦，也能体验到克服困难、解决问题的经历，甚至能对某些自己不曾接触过的领域，产生那么一点兴趣的火花。只要有这一点火花，未来何尝不能成为燎原之火。

作为进阶书籍，我打算严格地按照进阶书来写，即要满足如下的原则：

1. 不讲入门书籍讲到的语言基础知识。
2. 关注实践，收集真实的需求，采用真实的代码。
3. 关注进阶内容，如缺陷、性能、可读性等。
4. 不怕更新。

上述四个原则对本书的特色都有深远影响。

第一点，省略掉入门内容。这样我可以节省大量的篇幅，集中精力关注进阶内容。而市面上这么多入门书籍，再写的话，估计读者也八成已经接触过，不过是浪费纸张而已。我需要读者先读官方入门资料，如“Go Tour”，“Effective Go”，最好再读一本较全面的入门书籍，开发过一些代码。最后，还强烈推荐Rob Pike的演讲。正是他的演讲，让我真正意识到Go的强大之处。这样，再来读这本书，你就不会有任何障碍了。书中遇到需要预先知道的知识点时，只要有比较好的外部资料，都不会赘述，而是直接链接过去。这也是NeoReads的设计逻辑。

第二点，关注实践。书中的示例，尽量都用比较真实的数据、真实的需求。我力求大部分示例都来源于NeoReads项目本身、开源工程的实际代码，或者即使是为了话题完备而凑数的示例，也尽量避免那种过度简化，完全无法用在实际工程中的情形。当然，书本的篇幅空间有限，打印出来的代码肯定要经过简化，但是我会在配套的代码库中，给出完整的，考虑实际使用的代码。另外，与一般示例代码不同，我还会另外总结一个通用开发辅助库，[etgo](https://www.github.com/zhaopuming/etgo)，里面是我积累的各种通用函数，在实际项目中使用，也在本书中引用。以后读者读完本书后，很多功能可以直接采用`etgo`的代码。

第三点，关注进阶内容。写这本书就是为了让大家少采坑。所以采坑经历、填坑过程、以及亡羊补牢的措施，还有各种注意事项，都会尽力详述。而性能、可读性、维护性等代码的高阶设计特征，我会在实例中加以说明。另外，实际使用中，很多时候都会用第三方库，我会专门维护一个第三方库赏析的开源工程，来详细描述、分析和欣赏我用到的、并想介绍给大家的优秀第三方库。这也让本书再次跨越了篇幅限制。

第四点，不怕更新。传统技术书，因为出版频率限制，常常有跟不上技术更新的隐忧。Go语言发展这么迅速，这个问题更加凸显。很多书籍因为这个限制，而不得不抛弃很多话题。但我希望能想办法解决这个问题，从而能让我们接触到更多有意思的话题。比如第三方库，我会在书中做概念上、设计上、框架上、思路上的介绍，而实际代码，除了特别有趣的地方，其他的赏析会放在书外，放在第三方库赏析工程中，这样就避免了更新跟不上的问题。理念和思路不是那么容易变的，而且优秀的理念，往往是很值得铭记的。另一方面，为了保证纸质书不那么容易过期，我引用到的每一个示例，都会在网上维护代码，并且维护好历史变迁的情况。也就是说，假设你读过本书之后过两年再来看，但那时候书上的示例已经由于Go语言编译器的更新，跑不起来了，怎么办？很简单，访问该示例的在线代码库，找到对应版本，然后就会有链接介绍从这个版本之后的每一次更新，代码做了哪些改变，为什么要改变，直到最新的能跑的版本。

可以看出来，通过这些原则，我在本书中突破了很多技术书籍的限制，闻得到自由的空气了。而这种解放感，也是驱动我写这本书的动力。希望大家都能一同体会到。

## 我打算讨论哪些话题

首先，只要NeoReads涉及到的话题，我都要好好研究。
其次，即使没涉及到，但是我很感兴趣的话题，也要好好研究。
最后，如果大家很有需求，觉得需要了解的话题，我也会去研究。

我们先看NeoReads，想必你之前已经从链接跳过去看过了它的介绍，所以大概能想象到它会涉及到的话题：

- 并发 - Go语言绝对绕不开的话题
- 文本处理 - 书本的本体就是文本
- 文件操作 - 大部分书籍来源和存储方式都是文件
- 数据库读写 - 句子、评论、笔记、标注等都是存在数据库中的
- WEB API - 跟前台之间的接口要用到WEB API
- JSON等数据的处理 - 与前台数据传输用的是JSON
- 压缩 - 书籍在服务端都是压缩存储的
- 安全/加密 - 私人的信息，如笔记等全部实现加密存储
- 语音处理 - 朗读功能
- 图像处理 - 书籍封面、附图、评论表情等
- 运维 - 日志、配置、部署、监控等功能
- Debug - 日常开发遇到问题的解决方法汇总

然后是NeoReads短期涉及不到，但是我感兴趣的话题：

- Protobuf/FlatBuffers等数据格式
- 分布式与消息队列
- etcd
- 科学计算
- 云技术
- 多媒体处理
- 游戏编程
- 机器学习

至于其他还有哪些大家感兴趣的话题，欢迎在github上提出issue，或者我发博客时评论反馈。我会酌情去研究和添加上。

## 我打算如何组织这些话题

这本书的英文名叫Everyday Tasks with Go。这里有个重点词Task。本书就是打算以Task（任务）来组织话题。

每个章节是一个大的话题，比如第二章是并发，第四章是文件处理。每个章节中，会有很多该话题的细化，以任务进行组织。具体来说，就是每解决一个问题，或者一个细微的需求，就做成一个任务。每一个任务独立成型：我们会对每个任务做需求分析、解决思路的讨论、（多种）解决方案的展示与分析、注意事项、扩展话题等。

任务之间的递进关系，一般以难易度来划分。我一般都会先介绍最基础的任务，再逐渐列出更难的，更有挑战性的任务。最后一个任务，往往是扩展型的应用，我会举出一个较为现实的复杂任务，综合该话题前面讲到的多个细节，形成一个独立的小应用。比如文件处理的话题，最终的综合应用就是分析多个目录的压缩文件，并对其进行统计。这就是涉及到了文件夹、文件搜索、解压缩、读取文件、分析格式、计算等多个任务的综合。

## 这本书配套的应用NeoReads是什么样的

NeoReads是一个读书app，它的目标是可以读任何语言的书籍。总的来说，这是一个用来学习外语和古文的阅读app，并包含了笔记、评注、词典、多语对照等工具，是一个很实用的学习工具。

具体的特色，可以参考它的GitHub主页：https://github.com/neostudy/neoreads

这个应用的后台主要操作是读写数据库、处理书籍文件、支持WEB/APP访问，以及必要的统计工作。

整个应用，包括前台和后台，都是开源的。整个app的运营，也是透明的。用户的个人数据，采取个人加密方式（前台移动端生成秘钥，只有它能解锁私密内容），云端存储加密内容。

初期只有公版内容，如古腾堡、青空文库、中华诗词等，因此连数据库都可以开源。

后期如果用户支持足够，再找出版商合作，则会做更多的版权内容。并扩展到语音、视频、多媒体的领域，成为一个综合性教育应用。

但不管做到什么程度，其开源、开放、透明运营的原则都不会变。因此会一直陪伴本书下去。

## 我对这本书的要求、目标是什么。

希望达到什么样的水平和效果。写完之后我有什么收获。读完之后读者又会有什么收获。

## 重要的是过程

写作的过程。

学习的过程。克服困难的过程。收集资料的过程。优化的过程。

展现这个过程，如果能给读者一些启示，用到自己的事业中，那真是值得庆贺的事情。
